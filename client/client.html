<!DOCTYPE html>
<html lang="en">

<head>
  <title>Homestuck OST API Test</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script>
    const buildTracksDiv = (content, data) => {
      const trackDiv = document.createElement('div');
      trackDiv.className = "tracksDiv";

      const nameH = document.createElement('h3');
      const artistP = document.createElement('p');
      const albumP = document.createElement('p');
      const image = document.createElement('img');

      // If there is a valid URL, make the header a link. Otherwise just make it text
      if (data.urls[0]) {
        nameH.innerHTML = `<a href="${data.urls[0]}">${data.name}</a>`;
      }
      else {
        nameH.textContent = data.name;
      }

      // First artist
      artistP.textContent = 'By ' + data.artists[0].artistName;

      // All other artists
      for (let j = 1; j < data.artists.length; j++) {
        artistP.textContent = artistP.textContent + ", " + data.artists[j].artistName;
      }

      albumP.textContent = 'Album: ' + data.album;
      image.src = data.trackArt;
      image.width = 200;
      image.height = 200;

      nameH.className = "trackName";
      artistP.className = "trackArtist";
      albumP.className = "trackAlbum";
      image.className = "trackImage";

      trackDiv.appendChild(nameH);
      trackDiv.appendChild(artistP);
      trackDiv.appendChild(albumP);
      trackDiv.appendChild(image);

      // Check for rating
      if (data.rating) {
        const ratingH = document.createElement('h3');

        ratingH.textContent = "Rating: " + data.rating + "/10"

        ratingH.className = "trackRating";

        trackDiv.appendChild(ratingH);
      }

      content.appendChild(trackDiv);
    }

    const handleResponse = async (response) => {
      // get page content section and clear
      const content = document.querySelector('#content');
      const status = document.querySelector('#status');
      content.innerHTML = '';
      status.innerHTML = '';

      // Create header for status message
      let statusHeader = '';

      // Switch statement for header based on code
      switch (response.status) {
        case 200:
          statusHeader = 'Success';
          break;
        case 201:
          statusHeader = 'Created';
          break;
        case 204:
          statusHeader = 'Updated (No Content)';
          break;
        case 400:
          statusHeader = 'Bad Request';
          break;
        case 404:
          statusHeader = 'Not Found';
          break;
        default:
          statusHeader = 'Error not implemented. Something has gone very wrong!'
          break;
      }

      status.textContent = statusHeader;

      // get json obj
      const parsedJson = await response.json();

      // TODO: this is probably better as a switch
      if (parsedJson.id == "allTracks" || parsedJson.id == "getAllByArtist") {
        for (let i = 0; i < parsedJson.tracks.length; i++) {
          buildTracksDiv(content, parsedJson.tracks[i]);
        }
      }
      else if (parsedJson.id == "getTrack") {
        buildTracksDiv(content, parsedJson.track);
      }
      else if (parsedJson.id == "allArtists") {
        const artistsDiv = document.createElement('div');
        artistsDiv.className = "artistsDiv";

        const artistsP = document.createElement('p');

        // First artist
        artistsP.textContent = "Artists: " + parsedJson.artists[0].artistName;

        if (parsedJson.artists[0].rating) {
          artistsP.textContent = artistsP.textContent + ` (${parsedJson.artists[0].rating}/10)`;
        }

        for (let i = 1; i < parsedJson.artists.length; i++) {
          artistsP.textContent = artistsP.textContent + ", " + parsedJson.artists[i].artistName;

          if (parsedJson.artists[i].rating) {
            artistsP.textContent = artistsP.textContent + ` (${parsedJson.artists[i].rating}/10)`;
          }
        }

        artistsDiv.appendChild(artistsP);
        content.appendChild(artistsDiv);
      }
      else if (parsedJson.id == "allAlbums") {
        for (let i = 0; i < parsedJson.albums.length; i++) {
          const albumDiv = document.createElement('div');
          albumDiv.className = "albumDiv";

          const nameH = document.createElement('h3');
          const image = document.createElement('img');

          if (parsedJson.albums[i].urls[0]) {
            nameH.innerHTML = `<a href="${parsedJson.albums[i].urls[0]}">${parsedJson.albums[i].albumName}</a>`;
          }
          else {
            nameH.innerHTML = parsedJson.albums[i].albumName;
          }

          image.src = parsedJson.albums[i].albumArt;
          image.width = 300;
          image.height = 300;

          albumDiv.appendChild(nameH);
          albumDiv.appendChild(image);

          content.appendChild(albumDiv);
        }      
      }
      // Default behavior if nothing else has been set up
      else {
        const jsonDiv = document.createElement('div');
        jsonDiv.className = "infoDiv";

        const jsonP = document.createElement('p');

        jsonP.textContent = JSON.stringify(parsedJson);

        jsonDiv.appendChild(jsonP);
        content.appendChild(jsonDiv);
      }
    }


    const sendPostRequest = async (form) => {
      const url = form.getAttribute('action');
      const method = form.getAttribute('method');

      const format = form.querySelector('#formatSelect').value;

      const name = form.querySelector('#nameField').value;
      const rating = form.querySelector('#rateField').value;

      let formData;

      if (format == 'application/json') formData = JSON.stringify({ name, rating });
      else formData = `name=${name}&rating=${rating}`;

      const options = {
        method: 'POST',
        headers: {
          'Content-Type': format,
          'Content-Length': formData.length,
          'Accept': 'application/json'
        },
        body: formData
      }

      const fetchResponse = await fetch(url, options);

      handleResponse(fetchResponse);
    }

    // Can also handle HEAD requests
    const sendGetRequest = async (form) => {

      let url = form.querySelector('#urlField').value;
      const method = form.querySelector('#methodSelect').value;

      // Add query parameters if searchig for a particular song
      if (url == '/getTrack' || url == '/getAllByArtist') {
        url = url + '?' + new URLSearchParams({ searchParam: form.querySelector('#searchParamField').value });
      }

      const options = {
        method: method,
        headers: {
          'Accept': 'application/json'
        }
      }

      const fetchResponse = await fetch(url, options);

      handleResponse(fetchResponse);
    }


    const init = () => {
      const songRateForm = document.querySelector('#songRateForm');
      const artistRateForm = document.querySelector('#artistRateForm');
      const userForm = document.querySelector('#userForm');

      // Prevent the forms default behavior
      const sendSongPost = (e) => {
        e.preventDefault();
        sendPostRequest(songRateForm);
        return false;
      }

      const sendArtistPost = (e) => {
        e.preventDefault();
        sendPostRequest(artistRateForm);
        return false;
      }

      const sendGet = (e) => {
        e.preventDefault();
        sendGetRequest(userForm);
        return false;
      }

      songRateForm.addEventListener('submit', sendSongPost);
      artistRateForm.addEventListener('submit', sendArtistPost);
      userForm.addEventListener('submit', sendGet);
    }

    //When the window loads, run init.
    window.onload = init;
  </script>
</head>

<body>
  <section id="top">
    <h3>Homestuck OST API Tests</h3>
    <form id="songRateForm" action="/rateTrack" method="post">
      <select id="formatSelect">
        <option value="application/json">JSON</option>
        <option value="application/x-www-form-urlencoded">urlencoded</option>
      </select>
      <label for="name">Song Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="rating">Rating: </label>
      <input id="rateField" type="number" name="rating" min="0" max="10" step="1" />
      <input type="submit" value="Rate Song" />
    </form>
    <form id="artistRateForm" action="/rateArtist" method="post">
      <select id="formatSelect">
        <option value="application/json">JSON</option>
        <option value="application/x-www-form-urlencoded">urlencoded</option>
      </select>
      <label for="name">Artist Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="rating">Rating: </label>
      <input id="rateField" type="number" name="rating" min="0" max="10" step="1" />
      <input type="submit" value="Rate Artist" />
    </form>
    <form id="userForm" action="/getAllTracks" method="get">
      <select id='urlField'>
        <option value='/getAllTracks'>/getAllTracks</option>
        <option value='/getTrack'>/getTrack</option>
        <option value='/getAllByArtist'>/getAllByArtist</option>
        <option value='/getAllArtists'>/getAllArtists</option>
        <option value='/getAllAlbums'>/getAllAlbums</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <label for="searchParam">Track/Artist Name: </label>
      <input id="searchParamField" type="text" name="searchParam" />
      <input type="submit" value="Submit Request" />
    </form>
  </section>
  <h1 id="status"></h1>
  <section id="content">
  </section>
</body>

</html>