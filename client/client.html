<!DOCTYPE html>
<html lang="en">

<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">

  <script>
    const handleResponse = async (response) => {
      // get page content section and clear
      const content = document.querySelector('#content');
      content.innerHTML = '';

      // Create header for status message
      const statusHeader = document.createElement('h1');

      // Switch statement for header based on code
      switch (response.status) {
        case 200:
          statusHeader.textContent = 'Success';
          break;
        case 201:
          statusHeader.textContent = 'Created';
          break;
        case 204:
          statusHeader.textContent = 'Updated (No Content)';
          break;
        case 400:
          statusHeader.textContent = 'Bad Request';
          break;
        case 404:
          statusHeader.textContent = 'Not Found';
          break;
        default:
          statusHeader.textContent = 'Error not implemented. Something has gone very wrong!'
          break;
      }

      content.appendChild(statusHeader);

      // get json obj
      const parsedJson = await response.json();

      // TODO: this is probably better as a switch
      if (parsedJson.id == "allTracks") {
        for (let i = 0; i < parsedJson.tracks.length; i++) {
          const trackDiv = document.createElement('div');
          trackDiv.className = "trackDiv";

          const nameH = document.createElement('h3');
          const artistP = document.createElement('p');
          const albumP = document.createElement('p');
          const image = document.createElement('img');

          nameH.textContent = parsedJson.tracks[i].name;

          // First artist
          artistP.textContent = 'By ' + parsedJson.tracks[i].artists[0].artistName;

          // All other artists
          for (let j = 1; j < parsedJson.tracks[i].artists.length; j++) {
            artistP.textContent = artistP.textContent + ", " + parsedJson.tracks[i].artists[j].artistName;
          }

          albumP.textContent = 'Album: ' + parsedJson.tracks[i].album;
          image.src = parsedJson.tracks[i].trackArt;
          image.width = 200;
          image.height = 200;

          trackDiv.appendChild(nameH);
          trackDiv.appendChild(artistP);
          trackDiv.appendChild(albumP);
          trackDiv.appendChild(image);

          // Check for rating
          if (parsedJson.tracks[i].rating){
            const ratingH = document.createElement('h3');

            ratingH.textContent = "Rating: " + parsedJson.tracks[i].rating + "/10"

            trackDiv.appendChild(ratingH);
          }

          content.appendChild(trackDiv);
        }
      }
      else if (parsedJson.id == "allArtists") {
        const artistsDiv = document.createElement('div');
        artistsDiv.className = "trackDiv"; // this is a lie i just dont want to do more classes rn

        const artistsP = document.createElement('p');

        // First artist
        artistsP.textContent = "Artists: " + parsedJson.artists[0].artistName;

        for (let i = 1; i < parsedJson.artists.length; i++){
          artistsP.textContent = artistsP.textContent + ", " + parsedJson.artists[i].artistName;
        }

        artistsDiv.appendChild(artistsP);
        content.appendChild(artistsDiv);
      }
      // Default behavior if nothing else has been set up
      else {
          const jsonDiv = document.createElement('div');
          jsonDiv.className = "trackDiv";

          const jsonP = document.createElement('p');

          jsonP.textContent = JSON.stringify(parsedJson);

          jsonDiv.appendChild(jsonP);
          content.appendChild(jsonDiv);
      }
    }


    const sendPostRequest = async (form) => {
      const url = form.getAttribute('action');
      const method = form.getAttribute('method');

      const name = form.querySelector('#nameField').value;
      const rating = form.querySelector('#rateField').value;

      const formData = JSON.stringify({ name, rating });

      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Content-Length': formData.length,
          'Accept': 'application/json'
        },
        body: formData
      }

      const fetchResponse = await fetch(url, options);

      handleResponse(fetchResponse);
    }

    // Can also handle HEAD requests
    const sendGetRequest = async (form) => {

      let url = form.querySelector('#urlField').value;
      const method = form.querySelector('#methodSelect').value;

      // Add query parameters if searchig for a particular song
      if (url == '/getTrack'){
        url = url + '?' + new URLSearchParams({trackName: form.querySelector('#trackNameField').value});
      }

      const options = {
        method: method,
        headers: {
          'Accept': 'application/json'
        }
      }

      const fetchResponse = await fetch(url, options);

      handleResponse(fetchResponse);
    }


    const init = () => {
      const nameForm = document.querySelector('#nameForm');
      const userForm = document.querySelector('#userForm');

      // Prevent the forms default behavior
      const sendPost = (e) => {
        e.preventDefault();
        sendPostRequest(nameForm);
        return false;
      }

      const sendGet = (e) => {
        e.preventDefault();
        sendGetRequest(userForm);
        return false;
      }

      nameForm.addEventListener('submit', sendPost);
      userForm.addEventListener('submit', sendGet);
    }

    //When the window loads, run init.
    window.onload = init;
  </script>
</head>

<body>
  <section id="top">
    <h3>POST Status Code Tests</h3>
    <form id="nameForm" action="/rateTrack" method="post">
      <label for="name">Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="rating">Rating: </label>
      <input id="rateField" type="number" name="rating" min="0" max="10" step="1" />
      <input type="submit" value="Add User" />
    </form>
    <form id="userForm" action="/getAllTracks" method="get">
      <select id='urlField'>
        <option value='/getAllTracks'>/getAllTracks</option>
        <option value='/getTrack'>/getTrack</option>
        <option value='/getAllArtists'>/getAllArtists</option>
        <option value='/getAllAlbums'>/getAllAlbums</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <label for="trackName">Track Name: </label>
      <input id="trackNameField" type="text" name="trackName"/>
      <input type="submit" value="Submit Request" />
    </form>
  </section>
  <section id="content">
  </section>
</body>

</html>